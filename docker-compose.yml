# =================================================================
# Docker Compose - MS Negocio Comercial Gestión Prospectos
# Stack: PostgreSQL + LocalStack (S3) + Spring Boot WebFlux
# =================================================================

services:
  postgres:
    image: postgres:15-alpine
    container_name: ayni-postgres
    environment:
      POSTGRES_DB: db_prospectos
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_prospectos_data:/var/lib/postgresql/data
      # Script de inicialización (opcional)
      - ./src/main/resources/db/migration/V1__init_schema.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d db_prospectos"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - ayni-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: ayni-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@nitro.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - "5050:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - ayni-network
    restart: unless-stopped
    profiles:
      - tools

  localstack:
    image: localstack/localstack:3.0
    container_name: ayni-localstack
    environment:
      SERVICES: s3
      DEBUG: 0
      AWS_DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      LOCALSTACK_API_KEY: ""
    ports:
      - "4566:4566"
      - "4510-4559:4510-4559"
    volumes:
      - localstack_data:/var/lib/localstack
      - ./scripts/init-localstack.sh:/etc/localstack/init/ready.d/init-s3.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - ayni-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  ms-neg-prospectos:
    build:
      context: .
      dockerfile: Dockerfile
      # DOCKER_BUILDKIT=1 docker-compose build
    image: ms-neg-prospectos:latest
    container_name: ms-neg-prospectos
    environment:
      SPRING_PROFILES_ACTIVE: docker

      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: db_prospectos
      DB_USERNAME: postgres
      DB_PASSWORD: password

      R2DBC_POOL_INITIAL_SIZE: 10
      R2DBC_POOL_MAX_SIZE: 20
      R2DBC_POOL_MAX_IDLE_TIME: 30m

      AWS_REGION: us-east-1
      AWS_ENDPOINT: http://localstack:4566
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test

      S3_BUCKET_NAME: nitro-prospectos-assets-dev
      S3_ENDPOINT_OVERRIDE: http://localstack:4566

      CLOUD_AWS_CREDENTIALS_USE_DEFAULT_AWS_CREDENTIALS_CHAIN: false
      CLOUDWATCH_METRICS_ENABLED: false
      SALESFORCE_INTEGRATION_ENABLED: false
      REACTOR_NETTY_IOWORKERCOUNT: 4

      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_NITRO: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_R2DBC: DEBUG
      LOGGING_LEVEL_IO_R2DBC_POSTGRESQL: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG

      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics,prometheus
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always

      SPRING_WEBFLUX_TIMEOUT: 30s

      TZ: America/Lima

    ports:
      - "8080:8080"

    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - ayni-network

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

volumes:
  postgres_prospectos_data:
    driver: local
    name: ayni_postgres_prospectos_data

  pgadmin_data:
    driver: local
    name: ayni_pgadmin_data

  localstack_data:
    driver: local
    name: ayni_localstack_data

networks:
  ayni-network:
    driver: bridge
    name: ayni-network